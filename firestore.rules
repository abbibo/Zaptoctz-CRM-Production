rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getRole() {
      return request.auth.token.role;
    }
    
    function isAdmin() {
      return isSignedIn() && getRole() == 'admin';
    }
    
    function isManager() {
      return isSignedIn() && getRole() == 'manager';
    }
    
    function isMember() {
      return isSignedIn() && getRole() == 'member';
    }

    match /members/{userId} {

      
      // Allow users to read their own profile.
      // Allow Admins and Managers to read all profiles.
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin() || isManager());
      
      // Allow users to update their own profile, but NOT the 'role' field.
      // Allow Admins to update everything including roles.
      allow update: if (isSignedIn() && request.auth.uid == userId && 
                        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))) 
                    || isAdmin();
      
      // Allow Admins to create/delete users
      allow delete: if isAdmin();
      
      // Allow users to create their own profile during registration (if applicable)
      // but they cannot set the 'role' to admin/manager directly.
      // Admins are permitted to create users with any fields.
      allow create: if isAdmin() || (isSignedIn() && request.auth.uid == userId &&
                      (!request.resource.data.keys().hasAny(['role']) || request.resource.data.role == 'member'));


    }
    
    match /leads/{leadId} {
      // Admins and Managers can read all leads.
      // Members can read leads assigned to them.
      allow read: if isAdmin() || isManager() || 
                  (isMember() && resource.data.assignedTo == request.auth.uid);
                  
      // Admins, Managers, and Members can create leads.
      // Members can only create leads assigned to themselves.
      allow create: if isAdmin() || isManager() || 
                    (isMember() && request.resource.data.assignedTo == request.auth.uid);
      
      // Admins and Managers can update any lead.
      // Members can update leads assigned to them.
      allow update: if isAdmin() || isManager() || 
                    (isMember() && resource.data.assignedTo == request.auth.uid);
                    
      allow delete: if isAdmin() || isManager();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
